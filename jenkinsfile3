pipeline {
    agent any

    tools {
        jdk 'JDK21'
        nodejs 'NodeJS'
    }

    environment {
        SCANNER_HOME = tool 'sonarqube-scanner'
        IMAGE_NAME = "ramesh0621/bookmyshowapp"
        IMAGE_TAG = "build-${BUILD_NUMBER}"
    }

    stages {

        stage('Clear workspace ') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Trivy Filesystem Scan') {
            steps {
                // Install Trivy (optional if already on agent)
                sh 'which trivy || curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh'
                
                // Run Trivy scan on workspace
                sh 'trivy fs --severity HIGH,CRITICAL --format table ${WORKSPACE}'

                // Optional: save output to a file
                sh 'trivy fs --severity HIGH,CRITICAL --format json ${WORKSPACE} > trivy-report.json'
            }
        }

        stage('Docker Build') {
            steps {
                sh """
                    echo "Building Docker image..."
                    docker build --no-cache \
                        -t ${IMAGE_NAME}:${BUILD_NUMBER} \
                        -f bookmyshow-app/Dockerfile bookmyshow-app
                """
            }
        }

        stage('Docker Push') {
            steps {
                script {
                    withDockerRegistry([credentialsId: 'docker_credential', url: '']) {
                        sh """
                            echo "Pushing Docker image..."
                            docker push ${IMAGE_NAME}:${BUILD_NUMBER}
                        """
                    }
                }
            }
        }

        stage('Image Scan (Trivy)') {
            steps {
                sh "trivy image ${IMAGE_NAME}:${BUILD_NUMBER}"
            }
        }

        stage('Deploy to STAGE') {
            steps {
                sh """
                    ansible-playbook ansible/playbooks/deploy.yml \
                        -e namespace=bookmyshow-stage
                """
            }
        }

        stage('Approval for PROD') {
            steps {
                input message: "Deploy to Production?"
            }
        }

        stage('Deploy to PROD') {
            steps {
                sh """
                    ansible-playbook ansible/playbooks/deploy.yml \
                        -e namespace=bookmyshow-prod
                """
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully"
        }
        failure {
            echo "Pipeline failed"
        }
    }
}
